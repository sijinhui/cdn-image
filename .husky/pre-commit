#!/bin/sh

# Function to generate file list for a given directory
generate_file_list() {
    local dir=$1  # Ensure we properly handle the directory variable
    echo $dir
    local file_list="${dir}/file_list.txt"  # Proper path concatenation

    echo "Generating $file_list ..."

    # Ensure that the directory path is valid and exists
    mkdir -p "$dir"

    # Find all non-hidden files and directories, ignoring the hidden ones and write to file_list
    find "$dir" -maxdepth 1 -type f -not -name 'file_list.txt' -not -path '*/\.*' -exec basename {} \; > "$file_list"

    # del kong
    if [ ! -s "$file_list" ];
    then
        rm "$file_list"
        echo "file_list.txt was empty and has been deleted."
    else
        git add "$file_list"
    fi
}

# Export the function to be used by subshells
export -f generate_file_list

# Find all directories and generate file lists, excluding .git directories
find . -type d -not -path './node_modules' -not -path '*/\.*'
find . -type d -not -path './node_modules' -not -path '*/\.*' -exec bash -c 'generate_file_list "$1"' _ {} \;

# Add the generated file_list.txt files to the staging area
git add $(find . -name 'file_list.txt')
